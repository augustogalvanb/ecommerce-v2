# üîß E-commerce Backend - API RESTful

Backend del E-commerce desarrollado con NestJS, Prisma, PostgreSQL y TypeScript.

---

## üìã Tabla de Contenidos

- [Tecnolog√≠as](#-tecnolog√≠as)
- [Caracter√≠sticas](#-caracter√≠sticas)
- [Requisitos](#-requisitos)
- [Instalaci√≥n](#-instalaci√≥n)
- [Configuraci√≥n](#-configuraci√≥n)
- [Base de Datos](#-base-de-datos)
- [Ejecuci√≥n](#-ejecuci√≥n)
- [Endpoints](#-endpoints)
- [Arquitectura](#-arquitectura)
- [Testing](#-testing)
- [Deployment](#-deployment)

---

## üöÄ Tecnolog√≠as

- **Framework:** NestJS 10.x
- **Lenguaje:** TypeScript 5.x
- **Base de Datos:** PostgreSQL 15+
- **ORM:** Prisma 5.x
- **Autenticaci√≥n:** JWT (Passport)
- **Validaci√≥n:** class-validator, class-transformer
- **Pagos:** Mercado Pago SDK
- **Emails:** Nodemailer
- **PDFs:** PDFKit
- **Storage:** Cloudinary
- **Password:** bcrypt

---

## ‚ú® Caracter√≠sticas

### Autenticaci√≥n & Seguridad
- ‚úÖ Autenticaci√≥n con JWT
- ‚úÖ Guards para proteger rutas
- ‚úÖ Encriptaci√≥n de contrase√±as con bcrypt
- ‚úÖ Validaci√≥n de datos con DTOs
- ‚úÖ CORS configurado

### Gesti√≥n de Productos
- ‚úÖ CRUD completo de productos
- ‚úÖ Subida m√∫ltiple de im√°genes a Cloudinary
- ‚úÖ Eliminaci√≥n individual de im√°genes
- ‚úÖ Filtrado por categor√≠a y estado
- ‚úÖ B√∫squeda por slug
- ‚úÖ Gesti√≥n de stock autom√°tica

### Gesti√≥n de Pedidos
- ‚úÖ Creaci√≥n de pedidos sin autenticaci√≥n
- ‚úÖ Generaci√≥n autom√°tica de n√∫mero de pedido
- ‚úÖ Descuento autom√°tico de stock
- ‚úÖ Estados de pedido (PENDING, CONFIRMED, SHIPPED, DELIVERED, CANCELLED)
- ‚úÖ Estados de pago (PENDING, APPROVED, REJECTED, etc.)
- ‚úÖ Rastreo p√∫blico por n√∫mero de pedido
- ‚úÖ Panel admin para gesti√≥n completa

### Pagos
- ‚úÖ Integraci√≥n con Mercado Pago Checkout API
- ‚úÖ Procesamiento de pagos con tarjeta
- ‚úÖ Tokenizaci√≥n segura de tarjetas
- ‚úÖ Webhooks de Mercado Pago (preparado)
- ‚úÖ Actualizaci√≥n autom√°tica de estado

### Emails
- ‚úÖ Env√≠o autom√°tico de confirmaci√≥n
- ‚úÖ Generaci√≥n de factura en PDF
- ‚úÖ Template HTML responsive
- ‚úÖ Compatible con Gmail, Outlook, etc.

---

## üì¶ Requisitos

- Node.js v18 o superior
- PostgreSQL v15 o superior
- npm o yarn

### Cuentas de servicios externos:
- [Cloudinary](https://cloudinary.com) - Almacenamiento de im√°genes
- [Mercado Pago](https://www.mercadopago.com.ar/developers) - Procesamiento de pagos
- Gmail u otro SMTP - Env√≠o de emails

---

## üîß Instalaci√≥n

```bash
# Instalar dependencias
npm install
```

---

## ‚öôÔ∏è Configuraci√≥n

### Variables de Entorno (.env)

Crea un archivo `.env` en la ra√≠z del proyecto:

```env
# Database
DATABASE_URL="postgresql://user:password@localhost:5432/ecommerce_db?schema=public"

# JWT
JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"
JWT_EXPIRATION="7d"

# Cloudinary
CLOUDINARY_CLOUD_NAME="your_cloud_name"
CLOUDINARY_API_KEY="your_api_key"
CLOUDINARY_API_SECRET="your_api_secret"

# Mercado Pago
MERCADOPAGO_ACCESS_TOKEN="APP_USR-your-access-token-here"

# Email (Gmail example)
EMAIL_HOST="smtp.gmail.com"
EMAIL_PORT=587
EMAIL_USER="your-email@gmail.com"
EMAIL_PASSWORD="your-gmail-app-password"
EMAIL_FROM="TechStore <your-email@gmail.com>"

# App
PORT=3000
NODE_ENV="development"
FRONTEND_URL="http://localhost:5173"
```

### Obtener credenciales

#### Cloudinary
1. Reg√≠strate en [cloudinary.com](https://cloudinary.com)
2. Dashboard ‚Üí Account Details
3. Copia: Cloud Name, API Key, API Secret

#### Mercado Pago
1. Cuenta en [mercadopago.com.ar/developers](https://www.mercadopago.com.ar/developers)
2. Tus integraciones ‚Üí Credenciales
3. Modo **Pruebas**: Copia Access Token (APP_USR-...)
4. Modo **Producci√≥n**: Copia Access Token para deploy

#### Gmail App Password
1. Cuenta de Google ‚Üí Seguridad
2. Verificaci√≥n en 2 pasos ‚Üí Activar
3. Contrase√±as de aplicaciones ‚Üí Generar
4. Usa esa contrase√±a en `EMAIL_PASSWORD`

---

## üóÑÔ∏è Base de Datos

### Ejecutar migraciones

```bash
# Crear base de datos y aplicar migraciones
npx prisma migrate dev

# Generar cliente de Prisma
npx prisma generate
```

### Seed (Datos de prueba)

El seed carga autom√°ticamente:
- ‚úÖ 1 Admin (admin@ecommerce.com / admin123)
- ‚úÖ 4 Categor√≠as (Laptops, Smartphones, Auriculares, Accesorios)
- ‚úÖ 8 Productos con im√°genes (subidas a Cloudinary)

```bash
# Ejecutar seed
npm run prisma:seed
```

### Resetear base de datos

```bash
# Elimina todo, recrea, migra y ejecuta seed
npx prisma migrate reset

# Sin confirmaci√≥n (para scripts)
npx prisma migrate reset --force
```

### Prisma Studio (GUI)

```bash
# Abrir interfaz visual de la BD
npx prisma studio
```

Accesible en: `http://localhost:5555`

---

## üöÄ Ejecuci√≥n

### Desarrollo

```bash
npm run start:dev
```

La API estar√° disponible en: `http://localhost:3000`

### Producci√≥n

```bash
# Compilar
npm run build

# Ejecutar
npm run start:prod
```

---

## üì° Endpoints

### Autenticaci√≥n

#### POST `/api/auth/login`
Login de administrador

**Body:**
```json
{
  "email": "admin@ecommerce.com",
  "password": "admin123"
}
```

**Response:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "admin": {
    "id": "uuid",
    "email": "admin@ecommerce.com",
    "name": "Administrador"
  }
}
```

#### GET `/api/auth/me`
Obtener perfil del admin (requiere JWT)

**Headers:**
```
Authorization: Bearer {token}
```

---

### Categor√≠as

#### GET `/api/categories`
Listar todas las categor√≠as (p√∫blico)

**Response:**
```json
[
  {
    "id": "uuid",
    "name": "Laptops",
    "slug": "laptops",
    "createdAt": "2025-01-01T00:00:00.000Z",
    "updatedAt": "2025-01-01T00:00:00.000Z",
    "_count": {
      "products": 5
    }
  }
]
```

#### GET `/api/categories/:id`
Obtener categor√≠a por ID con sus productos (p√∫blico)

#### GET `/api/categories/slug/:slug`
Obtener categor√≠a por slug (p√∫blico)

#### POST `/api/categories`
Crear categor√≠a (requiere JWT)

**Headers:**
```
Authorization: Bearer {token}
```

**Body:**
```json
{
  "name": "Nueva Categor√≠a"
}
```

#### PATCH `/api/categories/:id`
Actualizar categor√≠a (requiere JWT)

#### DELETE `/api/categories/:id`
Eliminar categor√≠a (requiere JWT)
- ‚ö†Ô∏è No se puede eliminar si tiene productos asociados

---

### Productos

#### GET `/api/products`
Listar productos (p√∫blico)

**Query Params:**
- `categoryId` (opcional): Filtrar por categor√≠a
- `isActive` (opcional): true/false

**Response:**
```json
[
  {
    "id": "uuid",
    "name": "MacBook Pro 14\"",
    "slug": "macbook-pro-14",
    "description": "Laptop profesional...",
    "price": 2499.99,
    "stock": 15,
    "images": ["https://res.cloudinary.com/..."],
    "isActive": true,
    "categoryId": "uuid",
    "category": {
      "id": "uuid",
      "name": "Laptops",
      "slug": "laptops"
    },
    "createdAt": "2025-01-01T00:00:00.000Z",
    "updatedAt": "2025-01-01T00:00:00.000Z"
  }
]
```

#### GET `/api/products/:id`
Obtener producto por ID (p√∫blico)

#### GET `/api/products/slug/:slug`
Obtener producto por slug (p√∫blico)

#### POST `/api/products`
Crear producto con im√°genes (requiere JWT)

**Headers:**
```
Authorization: Bearer {token}
Content-Type: multipart/form-data
```

**Body (FormData):**
```
name: "Producto Nuevo"
description: "Descripci√≥n del producto"
price: 999.99
stock: 10
categoryId: "uuid"
isActive: true
images: [File, File, ...] (hasta 10 im√°genes)
```

#### PATCH `/api/products/:id`
Actualizar producto (requiere JWT)

#### DELETE `/api/products/:id/image`
Eliminar imagen espec√≠fica (requiere JWT)

**Body:**
```json
{
  "imageUrl": "https://res.cloudinary.com/..."
}
```

#### DELETE `/api/products/:id`
Eliminar producto (requiere JWT)
- ‚ö†Ô∏è Elimina tambi√©n las im√°genes de Cloudinary

---

### Pedidos

#### POST `/api/orders`
Crear pedido (p√∫blico)

**Body:**
```json
{
  "customerName": "Juan P√©rez",
  "customerEmail": "juan@example.com",
  "customerPhone": "+54 381 123-4567",
  "items": [
    {
      "productId": "uuid",
      "quantity": 2
    }
  ]
}
```

**Response:**
```json
{
  "id": "uuid",
  "orderNumber": "ORD-1234567890-1234",
  "customerName": "Juan P√©rez",
  "customerEmail": "juan@example.com",
  "customerPhone": "+54 381 123-4567",
  "totalAmount": 4999.98,
  "status": "PENDING",
  "paymentStatus": "PENDING",
  "orderItems": [...],
  "createdAt": "2025-01-01T00:00:00.000Z"
}
```

#### GET `/api/orders`
Listar pedidos (requiere JWT)

**Query Params:**
- `status` (opcional): PENDING | CONFIRMED | SHIPPED | DELIVERED | CANCELLED

#### GET `/api/orders/number/:orderNumber`
Obtener pedido por n√∫mero (p√∫blico)

#### GET `/api/orders/:id`
Obtener pedido por ID (requiere JWT)

#### PATCH `/api/orders/:id/status`
Actualizar estado del pedido (requiere JWT)

**Body:**
```json
{
  "status": "CONFIRMED"
}
```

Estados v√°lidos:
- `PENDING` - Pendiente
- `CONFIRMED` - Confirmado
- `SHIPPED` - Enviado
- `DELIVERED` - Entregado
- `CANCELLED` - Cancelado

#### DELETE `/api/orders/:id`
Eliminar pedido (requiere JWT)
- ‚ö†Ô∏è Si est√° en PENDING, devuelve el stock

---

### Pagos

#### POST `/api/payments/process`
Procesar pago con Mercado Pago (p√∫blico)

**Body:**
```json
{
  "orderId": "uuid",
  "token": "card_token_from_mercadopago_sdk",
  "paymentMethodId": "master",
  "installments": 1,
  "payer": {
    "email": "customer@example.com",
    "identification": {
      "type": "DNI",
      "number": "12345678"
    }
  }
}
```

**Response:**
```json
{
  "success": true,
  "status": "approved",
  "statusDetail": "accredited",
  "paymentId": "1234567890",
  "order": {
    "id": "uuid",
    "orderNumber": "ORD-...",
    "status": "CONFIRMED",
    "paymentStatus": "APPROVED",
    ...
  }
}
```

Estados de pago:
- `PENDING` - Pendiente
- `APPROVED` - Aprobado
- `REJECTED` - Rechazado
- `IN_PROCESS` - En proceso
- `CANCELLED` - Cancelado
- `REFUNDED` - Reembolsado

#### GET `/api/payments/status/:paymentId`
Consultar estado de pago en Mercado Pago (p√∫blico)

---

## üèóÔ∏è Arquitectura

### Estructura de m√≥dulos

```
src/
‚îú‚îÄ‚îÄ auth/                    # Autenticaci√≥n JWT
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ guards/
‚îÇ   ‚îú‚îÄ‚îÄ strategies/
‚îÇ   ‚îú‚îÄ‚îÄ auth.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ auth.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ auth.module.ts
‚îÇ
‚îú‚îÄ‚îÄ categories/              # Gesti√≥n de categor√≠as
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ categories.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ categories.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ categories.module.ts
‚îÇ
‚îú‚îÄ‚îÄ products/                # Gesti√≥n de productos
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ products.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ products.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ products.module.ts
‚îÇ
‚îú‚îÄ‚îÄ orders/                  # Gesti√≥n de pedidos
‚îÇ   ‚îú‚îÄ‚îÄ dtos/
‚îÇ   ‚îú‚îÄ‚îÄ orders.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ orders.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ orders.module.ts
‚îÇ
‚îú‚îÄ‚îÄ mercadopago/            # Integraci√≥n Mercado Pago
‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îú‚îÄ‚îÄ mercadopago.controller.ts
‚îÇ   ‚îú‚îÄ‚îÄ mercadopago.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ mercadopago.module.ts
‚îÇ
‚îú‚îÄ‚îÄ email/                  # Env√≠o de emails
‚îÇ   ‚îú‚îÄ‚îÄ email.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ email.module.ts
‚îÇ
‚îú‚îÄ‚îÄ cloudinary/             # Subida de im√°genes
‚îÇ   ‚îú‚îÄ‚îÄ cloudinary.provider.ts
‚îÇ   ‚îú‚îÄ‚îÄ cloudinary.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ cloudinary.module.ts
‚îÇ
‚îú‚îÄ‚îÄ prisma/                 # ORM
‚îÇ   ‚îú‚îÄ‚îÄ prisma.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ prisma.module.ts
‚îÇ
‚îú‚îÄ‚îÄ app.module.ts           # M√≥dulo principal
‚îî‚îÄ‚îÄ main.ts                 # Punto de entrada
```

### Prisma Schema

```prisma
model Admin {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Category {
  id        String    @id @default(uuid())
  name      String    @unique
  slug      String    @unique
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  products  Product[]
}

model Product {
  id          String      @id @default(uuid())
  name        String
  slug        String      @unique
  description String
  price       Decimal
  stock       Int
  images      String[]
  categoryId  String
  category    Category    @relation(fields: [categoryId], references: [id])
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  orderItems  OrderItem[]
}

model Order {
  id            String        @id @default(uuid())
  orderNumber   String        @unique
  customerName  String
  customerEmail String
  customerPhone String
  totalAmount   Decimal
  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  paymentId     String?
  paymentMethod String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  orderItems    OrderItem[]
}

model OrderItem {
  id           String  @id @default(uuid())
  orderId      String
  order        Order   @relation(fields: [orderId], references: [id])
  productId    String
  product      Product @relation(fields: [productId], references: [id])
  productName  String
  productPrice Decimal
  quantity     Int
  subtotal     Decimal
}

enum OrderStatus {
  PENDING
  CONFIRMED
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  APPROVED
  REJECTED
  IN_PROCESS
  CANCELLED
  REFUNDED
}
```

---

## üß™ Testing

```bash
# Unit tests
npm run test

# E2E tests
npm run test:e2e

# Test coverage
npm run test:cov
```

---

## üìú Scripts Disponibles

```bash
# Desarrollo
npm run start              # Inicia en modo normal
npm run start:dev          # Inicia con hot-reload
npm run start:debug        # Inicia en modo debug

# Build
npm run build              # Compila el proyecto

# Producci√≥n
npm run start:prod         # Inicia versi√≥n compilada

# Prisma
npm run prisma:generate    # Genera cliente de Prisma
npm run prisma:migrate     # Ejecuta migraciones
npm run prisma:studio      # Abre Prisma Studio
npm run prisma:seed        # Ejecuta seed
npm run prisma:reset       # Resetea BD + seed

# Linting
npm run lint               # Ejecuta ESLint
npm run format             # Formatea c√≥digo con Prettier

# Testing
npm run test               # Unit tests
npm run test:watch         # Tests en modo watch
npm run test:cov           # Coverage
npm run test:e2e           # E2E tests
```

---

## üåê Deployment

### Render.com (Recomendado)

1. **Crear PostgreSQL Database:**
   - New ‚Üí PostgreSQL
   - Copia la `Internal Database URL`

2. **Crear Web Service:**
   - New ‚Üí Web Service
   - Conectar repositorio GitHub
   - Root Directory: `back`
   - Build Command: `npm install && npx prisma generate && npm run build`
   - Start Command: `npm run start:prod`

3. **Variables de Entorno:**
   Agrega todas las variables del `.env`:
   - `DATABASE_URL` (usar Internal Database URL)
   - `JWT_SECRET`
   - `CLOUDINARY_*`
   - `MERCADOPAGO_ACCESS_TOKEN` (usar token de producci√≥n)
   - `EMAIL_*`
   - `FRONTEND_URL` (URL de Vercel)
   - `NODE_ENV=production`

4. **Deploy:**
   - El deploy se ejecuta autom√°ticamente
   - Las migraciones se aplican en cada deploy

### Railway / Heroku

Similar a Render, ajustar comandos seg√∫n la plataforma.

---

## üîí Seguridad

### Mejores pr√°cticas implementadas:

- ‚úÖ JWT para autenticaci√≥n
- ‚úÖ Contrase√±as hasheadas con bcrypt (salt rounds: 10)
- ‚úÖ Validaci√≥n de datos con class-validator
- ‚úÖ CORS configurado
- ‚úÖ Variables de entorno para secretos
- ‚úÖ Sanitizaci√≥n de inputs
- ‚úÖ Guards para proteger rutas sensibles

### Para producci√≥n:

- ‚ö†Ô∏è Cambiar `JWT_SECRET` por uno seguro y √∫nico
- ‚ö†Ô∏è Usar HTTPS en todas las comunicaciones
- ‚ö†Ô∏è Implementar rate limiting
- ‚ö†Ô∏è Agregar helmet para headers de seguridad
- ‚ö†Ô∏è Revisar logs de Cloudinary y Mercado Pago
- ‚ö†Ô∏è Configurar webhooks de Mercado Pago

---

## üìä Monitoreo y Logs

### Logs en Desarrollo

```bash
# Ver logs en tiempo real
npm run start:dev
```

### Logs en Producci√≥n (Render)

- Dashboard ‚Üí Logs ‚Üí Ver logs en tiempo real
- Filtrar por errores, warnings, etc.

---

## üêõ Troubleshooting

### Error: "Cannot connect to database"

**Soluci√≥n:**
- Verifica que PostgreSQL est√© corriendo
- Revisa `DATABASE_URL` en `.env`
- Verifica credenciales de la base de datos

### Error: "Cloudinary upload failed"

**Soluci√≥n:**
- Verifica credenciales de Cloudinary en `.env`
- Revisa l√≠mites de tu cuenta (free tier)
- Verifica que las im√°genes no excedan el tama√±o m√°ximo

### Error: "JWT token expired"

**Soluci√≥n:**
- El token expira seg√∫n `JWT_EXPIRATION` (default: 7 d√≠as)
- El usuario debe volver a hacer login
- Ajusta `JWT_EXPIRATION` si es necesario

### Error: "Mercado Pago payment rejected"

**Soluciones:**
- Verifica que uses tarjetas de prueba en desarrollo
- Usa nombre "APRO" para aprobar
- Revisa que el Access Token sea el correcto (test/prod)
- Verifica logs de Mercado Pago en su dashboard

---

## üìö Recursos Adicionales

- [NestJS Documentation](https://docs.nestjs.com/)
- [Prisma Documentation](https://www.prisma.io/docs)
- [Mercado Pago Docs](https://www.mercadopago.com.ar/developers/es/docs)
- [Cloudinary Docs](https://cloudinary.com/documentation)
- [Nodemailer Docs](https://nodemailer.com/about/)

---

## ü§ù Contribuir

Ver [README principal](../README.md) para gu√≠as de contribuci√≥n.

---

## üìù Notas de Versi√≥n

### v1.0.0
- ‚úÖ CRUD completo de productos, categor√≠as y pedidos
- ‚úÖ Autenticaci√≥n JWT
- ‚úÖ Integraci√≥n con Mercado Pago
- ‚úÖ Env√≠o de emails con facturas
- ‚úÖ Subida de im√°genes a Cloudinary
- ‚úÖ Seed autom√°tico con datos de prueba